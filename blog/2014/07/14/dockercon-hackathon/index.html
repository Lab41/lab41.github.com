
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DockerCon Hackathon - { lab41 }</title>
  <meta name="author" content="Lab41">

  
  <meta name="description" content="Recently, @schvin and I participated in Docker’s first 24-hour hackathon ahead of the first DockerCon. We were joined by 98 other tech junkies at &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lab41.github.io/blog/2014/07/14/dockercon-hackathon/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="{ lab41 }" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom/bootstrap.min.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom/bootstrap-responsive.min.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom/jquery.fancybox.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom/jquery.fancybox-extra.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom/jquery.fancybox-buttons.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom/jquery.fancybox-thumbs.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/tables.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom/kronecker.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.min.css" rel="stylesheet" type="text/css"/>

<script src="/javascripts/jquery-1.9.0.min.js" type="text/javascript"></script>

<script src="/javascripts/fancybox/jquery.fancybox.js" type="text/javascript"></script>
<script src="/javascripts/fancybox/jquery.fancybox-activate.js" type="text/javascript"></script>
<script src="/javascripts/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<script src="/javascripts/fancybox/jquery.fancybox-buttons.js" type="text/javascript"></script>
<script src="/javascripts/fancybox/jquery.fancybox-media.js" type="text/javascript"></script>
<script src="/javascripts/fancybox/jquery.fancybox-thumbs.js" type="text/javascript"></script>
<script src="/javascripts/jquery.mousewheel-3.0.6.pack.js" type="text/javascript"></script>
<script src="/javascripts/r_syntax.js" type="text/javascript"></script>
<script src="/javascripts/google_analytics.js" type="text/javascript"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js"></script>
<script src="https://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script>
<script src="/javascripts/mathjax.js" type="text/x-mathjax-config"></script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/javascript" src="/javascripts/kroneckerapp.js"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40906884-1, UA-40464073-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/"><img src="/images/lab41/logo.png" width="212" height="50" alt='Logo' %}> { blog }</a></h1>
  
    <h2>innovation through collaboration</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lab41.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h3 class="entry-title">DockerCon Hackathon</h3>
    
    
    
    
      <p class="meta">
        








  


<time datetime="2014-07-14T18:39:00+00:00" pubdate data-updated="true">Jul 14<span>th</span>, 2014</time>
        
  

<span class="byline author vcard"> - <span class="fn">Charlie Lewis</span></span>

        
        
      </p>
    
  </header>


<div class="entry-content"><div class="entry-content"><p>
Recently, <a href="https://github.com/schvin"><span class="citation" data-cites="schvin">@schvin</span></a> and I participated in <a href="http://www.docker.com/">Docker</a>’s first 24-hour hackathon ahead of the first <a href="http://www.dockercon.com/">DockerCon</a>. We were joined by 98 other tech junkies at the Docker offices, each teaming up to build their own awesome projects in the hopes of winning the highly coveted DockerCon tickets as well as a speaking slot at the conference. <a href="https://github.com/schvin"><span class="citation" data-cites="schvin">@schvin</span></a> and I set off with an idea that spawned at the <a href="http://monitorama.com/">Monitorama</a> conference we attended in May.
</p>
<p>
After seeing a presentation on logging by <a href="https://github.com/torkelo"><span class="citation" data-cites="torkelo">@torkelo</span></a> around <a href="http://grafana.org/">Grafana</a> – which gives you all of the benefits one might get from <a href="http://logstash.net/">Logstash</a> and <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a>, but lets you use <a href="http://graphite.wikidot.com/">Graphite</a> and <a href="https://github.com/etsy/statsd/">StatsD</a> to provide a more timeseries-centric view of your logs – we decided that it would be cool if we could automatically ship logs from a Docker host, and the containers running on that Docker host, straight into Grafana without having to run extra services on the containers or enforce global changes on legacy containers.
</p>
<p>
Here is how we built it:
</p>
<p>
5:15 pm - We started the project at the kickoff of the hackathon with an initial commit to <em>Dockerana</em>.
</p>
<p>
<a class="fancybox-effects-a"  href=/images/post_6/initial.png><img src="/images/post_6/initial.png" title="Initial Commit" ></a>
</p>
<blockquote>
    <p>
Initial commit to <a href="https://github.com/dockerana/dockerana">Dockerana</a>
</p>
</blockquote>
<p>
For our idea to work, we had to overcome a number of hurdles related to three core aspects of Docker’s unique environment. First, we needed to ensure we could extract logs from both the host and its containers without having to modify the containers themselves. Second, in order to use Grafana, we had to incorporate several dependencies all within a Docker environment. Finally, we needed to come up with a standard format to wrap the Docker logs in so that the logs could be fed to Graphite and displayed with Grafana.
</p>
<p>
8:45 pm - Three and a half hours later, we had our initial working prototype: a single Docker container running Grafana and all of its dependencies, gleaning data from the Docker host, and shoving it into Graphite so that it was viewable via Grafana.
</p>
<p>
<a class="fancybox-effects-a"  href=/images/post_6/initial_data.png><img src="/images/post_6/initial_data.png" title="Initial Data" ></a>
</p>
<p>
While it was a good start, there was still a lot of work to be done. The following three tasks required significantly more thought and tinkering:
<ul>
 <li>
Getting log data from the containers themselves, and not just the host;
</li>
 <li>
Breaking out the monolithic Grafana container into a series of integrated components, each in their own containers; and
</li>
 <li>
Bringing it all together by automating the process of spinning up Grafana with its dependencies as well as collecting and aggregating the logs.
</li>
</p>
<p>
For our Grafana setup, we required six processes to be running, which in Dockerland translates to six containers that all know how to properly communicate and share data with each other. Below are the six services, which together work as a cohesive Grafana system:
<ul>
    <li>
Carbon
</li>
    <li>
Elasticsearch
</li>
    <li>
Grafana
</li>
    <li>
Graphite
</li>
    <li>
Nginx
</li>
    <li>
StatsD
</li>
  </ul>
Graphite is comprised of two components, an engine, and a backend. The backend is Carbon which gets fed the logs via StatsD. StatsD is a network daemon that listens for statistics, counters, timers, and events sent over UDP and aggregates it to pluggable backend services, such as Carbon. Graphite, the engine, is being served up through Nginx, an HTTP and reverse proxy server, making it available to Grafana. Elasticsearch allows different Grafana dashboards to be saved and loaded.
</p>
<p>
Here’s a roughly drawn diagram of how all of these technologies are wired up for Dockerana:
</p>
<p>
<a class="fancybox-effects-a"  href=/images/post_6/Image.png><img src="/images/post_6/Image.png" title="Dockerana Diagram" ></a>
</p>
<p>
Here in Dockerland, we can see how to spin up some of the necessary containers and how they are interconnected both through data and communication.
</p>
<pre class="prettyprint"><code>
# spin up carbon container with a volume
docker run -d \
           -p 2004:2004 \
           -p 7002:7002 \
           -v /opt/graphite \
           --name dockerana-carbon dockerana/carbon

# spin up a graphite container and connect the volume from carbon to it
docker run -d \
           --volumes-from dockerana-carbon \
           --name dockerana-graphite dockerana/graphite

# spin up an nginx container and link the networking exposed in graphite to it
docker run -d \
           -p 8080:80 \
           --link dockerana-graphite:dockerana-graphite-link \
           --name dockerana-nginx dockerana/nginx

</code></pre>
<p>
An astute eye might notice that when the Graphite container is spun up there does not appear to be any exposed networking specified for the Nginx container to link to. That is because we are not exposing any networking to the outside. Instead, we are using native Docker linking between containers through the Dockerfile. As you can see in the example below, the <code>EXPOSE</code> command allows those ports (in this case, 8000) to communicate between linked containers without being exposed to the outside world.
</p>
<pre class="prettyprint"><code>
FROM ubuntu:trusty
MAINTAINER Charlie Lewis <charliel@lab41.org>

RUN apt-get -y update
RUN apt-get -y install git \
                       python-django \
                       python-django-tagging \
                       python-simplejson \
                       python-memcache \
                       python-ldap \
                       python-cairo \
                       python-twisted \
                       python-pysqlite2 \
                       python-support \
                       python-pip


# graphite, carbon, and whisper
WORKDIR /usr/local/src
RUN git clone https://github.com/graphite-project/graphite-web.git
RUN git clone https://github.com/graphite-project/carbon.git
RUN git clone https://github.com/graphite-project/whisper.git
RUN cd whisper && git checkout master && python setup.py install
RUN cd carbon && git checkout 0.9.x && python setup.py install
RUN cd graphite-web && git checkout 0.9.x && python check-dependencies.py; python setup.py install

# make use of cache from dockerana/carbon
RUN apt-get -y install gunicorn

RUN mkdir -p /opt/graphite/webapp
WORKDIR /opt/graphite/webapp

ENV GRAPHITE_STORAGE_DIR /opt/graphite/storage
ENV GRAPHITE_CONF_DIR /opt/graphite/conf
ENV PYTHONPATH /opt/graphite/webapp

EXPOSE 8000

CMD ["/usr/bin/gunicorn_django", "-b0.0.0.0:8000", "-w2", "graphite/settings.py"]

</code></pre>
<blockquote>
    <p>
Snippet from <a href="https://github.com/dockerana/dockerana/blob/master/components/graphite/Dockerfile">Graphite Dockerfile</a>
</p>
</blockquote>
<p>
If we then look at the Nginx configuration snippet below, we can see how it is using that link to proxy through the Graphite content to Grafana:
</p>
<pre class="prettyprint"><code>
. . .

http {
  . . .

  server {
    listen 80 default_server;
    server_name _;

    open_log_file_cache max=1000 inactive=20s min_uses=2 valid=1m;

    location / {
        proxy_pass                 http://dockerana-graphite-link:8000;
        proxy_set_header           X-Real-IP   $remote_addr;
        proxy_set_header           X-Forwarded-For  $proxy_add_x_forwarded_for;

. . .

</code></pre>
<blockquote>
    <p>
Snippet from <a href="https://github.com/dockerana/dockerana/blob/master/components/nginx/nginx.conf">Nginx configuration file</a>
</p>
</blockquote>
<p>
With all of those components working nicely, we just needed a process to collect and aggregate logs. This sounds like a good candidate for a container - so that’s exactly what we did. We Dockerized that process as well into a simple container that runs a couple scripts which poll various parts of the Docker host to glean logs not only about the host but also about the containers running on the host.
</p>
<p>
Here is our simple Dockerfile to build the container to do the log collection, where the primary driver is <code><a href="https://github.com/dockerana/dockerana/blob/master/scripts/runner.sh">runner.sh</a></code>:
</p>
<pre class="prettyprint"><code>
FROM ubuntu:trusty
MAINTAINER George Lewis <schvin@schvin.net>

RUN apt-get update
RUN apt-get install -y sysstat make

RUN perl -MCPAN -e 'install Net::Statsd'

ADD scripts/ingest.pl /usr/local/bin/
ADD scripts/loop.pl /usr/local/bin/
ADD scripts/periodic-ingest.sh /usr/local/bin/
ADD scripts/runner.sh /usr/local/bin/

CMD /usr/local/bin/runner.sh
</code></pre>
<blockquote>
    <p>
Snippet from <a href="https://github.com/dockerana/dockerana/blob/master/Dockerfile">Main Dockerfile</a>
</p>
</blockquote>

<p>
Now for the fun part: displaying the data. We built a dashboard that is mostly centered around the events on the Docker host. In the future we hope to add automatic dashboards specific to containers, but there’s only so much two people can do in 24 hours.
</p>
<p>
Here are some screenshots of what the dashboard looks like, all dynamically configurable:
</p>
<p>
<a class="fancybox-effects-a"  href=/images/post_6/dashboard1.png><img src="/images/post_6/dashboard1.png" title="Dockerana Dashboard" ></a>
</p>
<p>
Note that here we can see the virtual network interfaces of each container as well as the host:
</p>
<p>
<a class="fancybox-effects-a"  href=/images/post_6/dashboard2.png><img src="/images/post_6/dashboard2.png" title="Dockerana Dashboard" ></a>
</p>

<p>
Finally, we wanted it to be easy to setup and repeatable by anyone running a Docker host. Below is a screencast showing just how simple it is to get Dockerana up and running:
</p>
<div style="width:600px;">
<script type="text/javascript" src="https://asciinema.org/a/10047.js" id="asciicast-10047" async data-speed="2" data-size="small" data-autoplay=0></script>
</div>
<p>
DockerCon was a great event. We learned a lot, and got to see a lot of other interesting ideas around Docker that other groups worked on. You can find our presentation as well as those from the other groups that participated on the <a href="http://blog.docker.com/2014/07/dockercon-video-dockercon-hackathon-winners/">Docker Blog</a>. We are definitely looking forward to the next hackathon.
</p></div></div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Charlie Lewis</span></span>

      








  


<time datetime="2014-07-14T18:39:00+00:00" pubdate data-updated="true">Jul 14<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://lab41.github.io/blog/2014/07/14/dockercon-hackathon/" data-via="" data-counturl="http://lab41.github.io/blog/2014/07/14/dockercon-hackathon/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/04/24/gitting-better-teamwork/" title="Previous Post: Git-ting Better Teamwork Around Graph Analytics">&laquo; Git-ting Better Teamwork Around Graph Analytics</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/07/22/five-steps-to-demonstration-and-delivery/" title="Next Post: Five Steps to Demonstration and Delivery">Five Steps to Demonstration and Delivery &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  This project is maintained by the <a href="https://github.com/LAB41">Lab41</a> Team to serve as a platform of discussion on technology topics relevant to Lab41 Challenges. More information about Lab41 can be found at <a href="http://www.lab41.org">www.lab41.org</a>.
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/28/triplewide-trailer-looking-to-rig-ipython/">Triplewide Trailer, Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/13/ipython-on-spark-on-docker/">Using Docker to Build an IPython-driven Spark Deployment</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/13/skyline/">Introducing...SKYLINE</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/04/circulo-community-detection/">Circulo: A Community Detection Evaluation Framework</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/18/rolx-discovering-individuals-roles-in-a-social-network/">Beyond Community Detection - RolX</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/lab41">@lab41</a> on GitHub
  
  <script type="text/javascript">
   (function($) {
    $(document).on('ready', function() {
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'lab41',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
   })(jQuery);
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Blog Authors</h1>
  <ul id="blog_authors">
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li><a href="https://github.com/kylef-lab41" target="_blank">Kyle Foster</a></li>
    <li><a href="https://github.com/aganeshLab41" target="_blank">Abhinav Ganesh</a></li>
    <li><a href="https://github.com/ks-lab41" target="_blank">Kabir Soorya</a></li>
    <li><a href="https://github.com/Lab41PaulM" target="_blank">Paul Mazzuca</a></li>
    <li><a href="https://github.com/ymt123" target="_blank">Yonas Tesfaye</a></li>
    <li><a href="https://github.com/nadesai" target="_blank">Nikhil Desai</a></li>
    <li><a href="https://github.com/cglewis" target="_blank">Charlie Lewis</a></li>
    <li><a href="https://github.com/ostrowr" target="_blank">Robbie Ostrow</a></li>
    <li><a href="https://github.com/karkumar" target="_blank">Karthik Ramachandran</a></li>
  </ul>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Lab41 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</a></span>
  <br>
  <span>
    Background image: <a href="https://www.flickr.com/photos/vkurland/8219699128">"Stanford Dish hiking trail"</a> by <a href="https://www.flickr.com/photos/vkurland/">Vadim Kurland</a>, used under <a href="https://creativecommons.org/licenses/by/2.0">CC BY 2.0</a> / Desaturated from original
  </span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
